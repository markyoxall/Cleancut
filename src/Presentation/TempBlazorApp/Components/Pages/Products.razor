@page "/products"
@using CleanCut.Application.DTOs
@using TempBlazorApp.Services
@inject IProductService ProductService
@inject ILogger<Products> Logger

<PageTitle>Products - TempBlazorApp</PageTitle>

<div class="container py-4">
    <div class="row">
  <div class="col-12">
        <h2><i class="fas fa-box me-2"></i>Products</h2>
  <p class="text-muted">Data from CleanCut API using OAuth2.1 authentication</p>

 <AuthorizeView>
     <Authorized>
       @if (isLoading)
   {
        <div class="text-center py-5">
          <div class="spinner-border text-primary" role="status">
  <span class="visually-hidden">Loading...</span>
             </div>
  <p class="mt-3 text-muted">Loading products...</p>
  </div>
  }
       else if (products.Any())
      {
         <div class="alert alert-success">
         <i class="fas fa-check-circle me-2"></i>
  Successfully loaded <strong>@products.Count</strong> products
  </div>

     <div class="row">
          @foreach (var product in products)
    {
     <div class="col-md-6 col-lg-4 mb-3">
       <div class="card">
   <div class="card-body">
    <h6 class="card-title">@product.Name</h6>
    <p class="card-text small text-muted">@product.Description</p>
        <div class="d-flex justify-content-between align-items-center">
           <span class="h6 text-success mb-0">${@product.Price:F2}</span>
           <span class="badge @(product.IsAvailable ? "bg-success" : "bg-secondary")">
       @(product.IsAvailable ? "Available" : "Unavailable")
        </span>
           </div>
          </div>
     </div>
</div>
          }
    </div>
      }
      else if (hasError)
     {
          <div class="alert alert-danger">
         <i class="fas fa-exclamation-triangle me-2"></i>
       <strong>Error:</strong> @errorMessage
         </div>
   }
    else
        {
    <div class="alert alert-info">
       <i class="fas fa-info-circle me-2"></i>
         No products found
    </div>
      }

         <!-- Actions -->
  <div class="mt-4 d-flex gap-2">
           <button class="btn btn-outline-primary" @onclick="RefreshProducts" disabled="@isLoading">
    <i class="fas fa-sync me-1"></i>Refresh
         </button>
         <a href="/" class="btn btn-outline-secondary">
        <i class="fas fa-home me-1"></i>Home
        </a>
<form method="post" action="/Account/Logout" style="display:inline;">
      <button type="submit" class="btn btn-outline-danger">
     <i class="fas fa-sign-out-alt me-1"></i>Logout
    </button>
    </form>
      </div>
           </Authorized>
   
      <NotAuthorized>
       <div class="alert alert-warning">
     <h5 class="alert-heading">
            <i class="fas fa-lock me-2"></i>Authentication Required
         </h5>
         <p>You must be logged in to view products from the API.</p>
   <div class="mt-3">
       <a href="/Account/Login" class="btn btn-primary">
    <i class="fas fa-sign-in-alt me-2"></i>Login
        </a>
     <a href="/" class="btn btn-outline-secondary ms-2">
        <i class="fas fa-home me-2"></i>Home
         </a>
     </div>
   </div>
  </NotAuthorized>
         </AuthorizeView>
       </div>
 </div>
</div>

@code {
    private List<ProductInfo> products = new();
  private bool isLoading = false;
    private bool hasError = false;
    private string errorMessage = "";

    protected override async Task OnInitializedAsync()
    {
     await LoadProducts();
    }

    private async Task LoadProducts()
    {
   try
        {
   isLoading = true;
 hasError = false;
          errorMessage = "";
          StateHasChanged();

      Logger.LogInformation("Loading products from API");
         products = await ProductService.GetProductsAsync();
      }
        catch (Exception ex)
   {
     Logger.LogError(ex, "Error loading products");
     hasError = true;
     errorMessage = ex.Message;
        }
   finally
   {
      isLoading = false;
    StateHasChanged();
    }
    }

    private async Task RefreshProducts()
    {
 await LoadProducts();
    }
}