@page "/debug-services"
@using CleanCut.BlazorWebApp.Services.Auth
@inject ITokenService TokenService
@inject ILogger<DebugServices> Logger

@rendermode @(new InteractiveServerRenderMode(prerender: true))

<PageTitle>Debug Services - CleanCut</PageTitle>

<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
     <h1 class="display-6 fw-bold text-primary">
        <i class="fas fa-bug me-2"></i>Debug Services
       </h1>
       <p class="text-muted">Test OAuth 2.1 authentication service</p>
     </div>
    </div>

 <div class="row mb-4">
      <div class="col-12">
            <div class="card">
  <div class="card-header">
     <h5 class="card-title mb-0">
             <i class="fas fa-cogs me-2"></i>OAuth 2.1 Authentication Tests
     </h5>
         </div>
         <div class="card-body">
  <button class="btn btn-primary me-2" @onclick="TestTokenService">
     <i class="fas fa-key me-2"></i>Test User Token
   </button>
        </div>
     </div>
   </div>
    </div>

    <div class="row">
   <div class="col-12">
      <div class="card">
    <div class="card-header">
     <h5 class="card-title mb-0">
       <i class="fas fa-info-circle me-2"></i>Authentication Test Results
        </h5>
    </div>
       <div class="card-body">
 <pre style="background-color: #f8f9fa; padding: 1rem; border-radius: 0.375rem; white-space: pre-wrap; font-family: 'Courier New', monospace; font-size: 0.875rem;">@testResults</pre>
          </div>
     </div>
</div>
    </div>
</div>

@code {
    private string testResults = "Click 'Test User Token' to verify OAuth 2.1 authentication...";

    private async Task TestTokenService()
 {
     testResults = "Testing OAuth 2.1 User Authentication...\n";
     StateHasChanged();

   try
 {
     var token = await TokenService.GetAccessTokenAsync();
      if (!string.IsNullOrEmpty(token))
   {
  testResults += $"? OAuth 2.1 Authentication: SUCCESS\n";
   testResults += $"   Token Length: {token.Length} characters\n";
          testResults += $"   Token Type: Bearer\n";
     testResults += $"   Token Preview: {token[..Math.Min(50, token.Length)]}...\n";
testResults += $"   Flow Type: Authorization Code + PKCE (OAuth 2.1)\n";
     testResults += $"   Client Type: Public Client (No Secret)\n";
        }
   else
  {
         testResults += "? OAuth 2.1 Authentication: FAILED - No token returned\n";
   testResults += "   Possible causes:\n";
  testResults += "   - User not authenticated\n";
        testResults += "   - IdentityServer not running\n";
        testResults += "   - Token expired\n";
         }
      }
catch (Exception ex)
 {
   testResults += $"? OAuth 2.1 Authentication: ERROR - {ex.Message}\n";
      }
    
     StateHasChanged();
   }
}
